{% extends 'base.html.twig' %}

{% block title %}
    Créer une sortie
{% endblock %}

{% block body %}

    <div class="container mt-2">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card mt-5">
                    <div class="card-header">
                        <h2 class="text-center text-light">Créer une sortie</h2>
                    </div>
                    <div class="card-body">
                        {{ form_start(sortieForm, {'attr': {'class': ' form'}}) }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.name, null, {'label': 'Nom de la sorte : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.name, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.startDate, null, {'label': 'Date et heure de la sortie : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.startDate, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.limiteDateInscription, null, {'label': 'Date limite d\'inscription : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.limiteDateInscription, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.maxInscriptionsNumber, null, {'label': 'Nombre de places : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.maxInscriptionsNumber, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.duration, null, {'label': 'Durée : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.duration, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.infosSortie, null, {'label': 'Description et infos : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.infosSortie, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                            </div>
                            <div class="col-md-6">
                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.campus, null, {'label': 'Campus : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.campus, {'attr': {'class': 'form-control'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.ville, null, {'label': 'Ville : ', 'label_attr': {'class': 'me-2' }}) }}
                                    </div>
                                    <div class="col-7">
                                        {{ form_widget(sortieForm.ville, {'attr': {'class': 'form-control mb-3 ville'}}) }}
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        {{ form_label(sortieForm.lieu, null, {'label': 'Lieu : ', 'label_attr': {'class': 'me-2'}}) }}
                                    </div>
                                    <div class="col-7">
                                        <div class="input-group">
                                            {{ form_widget(sortieForm.lieu, {'attr': {'class': 'form-control'}}) }}
                                            <span class="input-group-text">
                                                <a href="{{ path('lieu-ajout') }}"><i class="fas fa-plus"></i></a>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        <label for="street">Rue : </label>
                                    </div>
                                    <div class="col-7">
                                        <span id="street">

                                        </span>
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        <label for="cPost">Code postal : </label>
                                    </div>
                                    <div class="col-7">
                                        <span id="cPost">

                                        </span>
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        <label for="latitude">Latitude : </label>
                                    </div>
                                    <div class="col-7">
                                        <span id="latitude">

                                        </span>
                                    </div>
                                </div>

                                <div class="row mb-3 align-items-center">
                                    <div class="col-5">
                                        <label for="longitude">Longitude : </label>
                                    </div>
                                    <div class="col-7">
                                        <span id="longitude">

                                        </span>
                                    </div>
                                </div>
                                <div class="row justify-content-center mb-5 mt-4">
                                    <div class="col-auto">
                                        <div class="d-flex justify-content-center">
                                            <button type="submit" class="btn btn-primary mx-2">Enregistrer</button>
                                            <button type="submit" class="btn btn-warning mx-2">Publier la sortie</button>
                                            <a href="{{ path('main_home') }}" class="btn btn-danger mx-2">Annuler</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    {{ form_end(sortieForm) }}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sélection des éléments DOM
        let villeSelect = document.getElementById('{{ sortieForm.ville.vars.id }}');
        let lieuSelect = document.getElementById('{{ sortieForm.lieu.vars.id }}');
        let codePostal = document.getElementById('cPost');
        let street = document.getElementById('street');
        let longitude = document.getElementById('longitude');
        let latitude = document.getElementById('latitude');

        // Écouteur d'événements pour la sélection de la ville
        villeSelect.addEventListener('change', (e) => {
            let villeId = e.target.value;

            // Récupérer les informations de la ville sélectionnée
            fetch('{{ path('ville-get', {'id': 'placeholder'}) }}'.replace('placeholder', villeId))
                .then(response => response.json())
                .then(data => {
                    codePostal.textContent = data.zipCode || 'Code postal non disponible';

                    // Récupérer et afficher les lieux correspondants à la ville sélectionnée
                    return fetch('{{ path('lieu-get', {'id': 'placeholder'}) }}'.replace('placeholder', villeId));
                })
                .then(response => response.json())
                .then(data => {
                    lieuSelect.innerHTML = '';
                    data.forEach(lieu => {
                        let option = new Option(lieu.name, lieu.id);
                        lieuSelect.add(option);
                    });
                    // Simule un changement pour mettre à jour les informations du premier lieu chargé
                    lieuSelect.dispatchEvent(new Event('change'));
                })
                .catch(err => console.error('Erreur lors de la récupération : ', err));
        });

        // Écouteur d'événements pour la sélection du lieu
        lieuSelect.addEventListener('change', (e) => {
            let lieuId = e.target.value;

            // Assurez-vous que le lieuId n'est pas vide
            if (!lieuId) {
                street.textContent = '';
                latitude.textContent = '';
                longitude.textContent = '';
                return;
            }

            // Récupérer et afficher les informations du lieu sélectionné
            fetch('{{ path('lieu-get', {'id': 'placeholder'}) }}'.replace('placeholder', lieuId))
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        let details = data.find(d => d.id == lieuId);
                        if (details) {
                            street.textContent = details.street || 'Rue non disponible';
                            latitude.textContent = details.latitude || 'Latitude non disponible';
                            longitude.textContent = details.longitude || 'Longitude non disponible';
                        }
                    }
                })
                .catch(err => console.error('Erreur lors de la récupération des détails du lieu : ', err));
        });
    </script>

{% endblock %}